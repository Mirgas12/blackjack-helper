<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Блэкджек Помощник</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--tg-theme-bg-color, #1a1a2e);
    color: var(--tg-theme-text-color, #e0e0e0);
    min-height: 100vh;
    padding: 8px;
    -webkit-user-select: none;
    user-select: none;
}

.container { max-width: 420px; margin: 0 auto; }

h1 {
    text-align: center;
    font-size: 18px;
    color: #f1c40f;
    padding: 8px 0;
    letter-spacing: 1px;
}

.section {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 8px;
}

.hand-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    min-height: 32px;
}

.hand-label {
    font-size: 13px;
    font-weight: 600;
    min-width: 65px;
}

.hand-label.dealer { color: #e74c3c; }
.hand-label.player { color: #2ecc71; }
.hand-label.others { color: #9b59b6; }
.hand-label.split-active { color: #2ecc71; }
.hand-label.split-inactive { color: #555; }

.hand-cards {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.card-chip {
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 4px 6px;
    font-size: 13px;
    font-weight: 700;
    min-width: 28px;
    text-align: center;
}

.hand-total {
    margin-left: auto;
    font-size: 13px;
    color: #bdc3c7;
}

/* Split hand rows */
.split-hand {
    cursor: pointer;
    border-radius: 6px;
    padding: 4px 6px;
    transition: background 0.15s;
}

.split-hand.active {
    background: rgba(46,204,113,0.08);
}

/* Рекомендация */
.recommendation {
    text-align: center;
    padding: 14px 10px;
    border-radius: 10px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.05);
    transition: all 0.2s;
}

.rec-action {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 2px;
}

.rec-explain {
    font-size: 12px;
    color: #bdc3c7;
    margin-top: 4px;
}

.rec-hit { border: 2px solid #2ecc71; }
.rec-hit .rec-action { color: #2ecc71; }

.rec-stand { border: 2px solid #e74c3c; }
.rec-stand .rec-action { color: #e74c3c; }

.rec-double { border: 2px solid #3498db; }
.rec-double .rec-action { color: #3498db; }

.rec-split { border: 2px solid #f39c12; }
.rec-split .rec-action { color: #f39c12; }

.rec-bust { border: 2px solid #e74c3c; background: rgba(231,76,60,0.15); }
.rec-bust .rec-action { color: #e74c3c; }

.rec-waiting { border: 1px solid rgba(255,255,255,0.1); }
.rec-waiting .rec-action { color: #7f8c8d; font-size: 16px; }

/* Split confirm */
.split-confirm {
    display: none;
    gap: 8px;
    margin-bottom: 8px;
}

.split-confirm.visible { display: flex; }

.split-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    border: 2px solid;
    background: transparent;
    -webkit-tap-highlight-color: transparent;
}

.split-btn:active { opacity: 0.7; }
.split-btn.yes { color: #f39c12; border-color: #f39c12; background: rgba(243,156,18,0.1); }
.split-btn.no { color: #7f8c8d; border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); }

/* Счётчик */
.counter-row {
    display: flex;
    justify-content: space-between;
    gap: 8px;
}

.counter-item {
    flex: 1;
    text-align: center;
}

.counter-value {
    font-size: 18px;
    font-weight: 700;
}

.counter-label {
    font-size: 10px;
    color: #7f8c8d;
}

.positive { color: #2ecc71; }
.negative { color: #e74c3c; }
.neutral { color: #3498db; }

/* Режим ввода */
.mode-buttons {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: 2px solid transparent;
    background: rgba(255,255,255,0.05);
    color: #7f8c8d;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
}

.mode-btn.active-dealer { border-color: #e74c3c; color: #e74c3c; background: rgba(231,76,60,0.1); }
.mode-btn.active-player { border-color: #2ecc71; color: #2ecc71; background: rgba(46,204,113,0.1); }
.mode-btn.active-others { border-color: #9b59b6; color: #9b59b6; background: rgba(155,89,182,0.1); }

/* Кнопки карт */
.card-grid {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 4px;
    margin-bottom: 6px;
    transition: opacity 0.15s;
}

.card-btn {
    padding: 10px 0;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    font-size: 15px;
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: all 0.1s;
    -webkit-tap-highlight-color: transparent;
}

.card-btn:active { transform: scale(0.93); }

.card-lo { background: rgba(46,204,113,0.15); color: #2ecc71; }
.card-mid { background: rgba(255,255,255,0.05); color: #bdc3c7; }
.card-hi { background: rgba(231,76,60,0.15); color: #e74c3c; }

.card-grid-row2 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
    margin-bottom: 8px;
    transition: opacity 0.15s;
}

/* Кнопки мастей */
.suit-row {
    display: none;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-bottom: 8px;
}

.suit-row.visible { display: grid; }

.suit-btn {
    padding: 14px 0;
    border-radius: 8px;
    border: 2px solid rgba(255,255,255,0.15);
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: all 0.1s;
    -webkit-tap-highlight-color: transparent;
}

.suit-btn:active { transform: scale(0.93); }
.suit-btn.red { background: rgba(231,76,60,0.15); color: #e74c3c; border-color: rgba(231,76,60,0.3); }
.suit-btn.black { background: rgba(255,255,255,0.08); color: #e0e0e0; }

.dimmed { opacity: 0.25; pointer-events: none; }

/* Управление */
.ctrl-row {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
}

.ctrl-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: rgba(255,255,255,0.08);
    color: #bdc3c7;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
}

.ctrl-btn:active { background: rgba(255,255,255,0.15); }

/* Результат руки */
.result-row {
    display: flex;
    gap: 6px;
    align-items: center;
}

.result-btn {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    border: 1px solid;
    background: transparent;
    -webkit-tap-highlight-color: transparent;
}

.result-btn.win { color: #2ecc71; border-color: #2ecc71; }
.result-btn.loss { color: #e74c3c; border-color: #e74c3c; }
.result-btn.push { color: #f39c12; border-color: #f39c12; }
.result-btn:active { opacity: 0.7; }

.decks-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.decks-row label { font-size: 12px; color: #7f8c8d; }

.decks-select {
    background: rgba(255,255,255,0.08);
    color: #e0e0e0;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 13px;
}

.deck-estimate {
    font-size: 12px;
    color: #f39c12;
    margin-top: 6px;
    display: none;
}

.stats {
    text-align: center;
    font-size: 12px;
    color: #7f8c8d;
    padding: 6px 0;
}
</style>
</head>
<body>
<div class="container">
    <h1>БЛЭКДЖЕК ПОМОЩНИК</h1>

    <!-- Руки -->
    <div class="section">
        <div class="hand-row">
            <span class="hand-label dealer">Дилер:</span>
            <div class="hand-cards" id="dealerCards"></div>
            <span class="hand-total" id="dealerTotal"></span>
        </div>
        <!-- Обычный режим -->
        <div class="hand-row" id="playerRow">
            <span class="hand-label player">Мои:</span>
            <div class="hand-cards" id="playerCards"></div>
            <span class="hand-total" id="playerTotal"></span>
        </div>
        <!-- Сплит режим -->
        <div class="hand-row split-hand" id="splitRow1" style="display:none" onclick="switchSplitHand(0)">
            <span class="hand-label split-active" id="splitLabel1">Рука 1 ▸</span>
            <div class="hand-cards" id="splitCards1"></div>
            <span class="hand-total" id="splitTotal1"></span>
        </div>
        <div class="hand-row split-hand" id="splitRow2" style="display:none" onclick="switchSplitHand(1)">
            <span class="hand-label split-inactive" id="splitLabel2">Рука 2:</span>
            <div class="hand-cards" id="splitCards2"></div>
            <span class="hand-total" id="splitTotal2"></span>
        </div>
        <!-- Чужие -->
        <div class="hand-row" id="othersRow" style="display:none">
            <span class="hand-label others">Чужие:</span>
            <div class="hand-cards" id="othersCards"></div>
            <span class="hand-total" id="othersCount"></span>
        </div>
    </div>

    <!-- Рекомендация -->
    <div class="recommendation rec-waiting" id="recBox">
        <div class="rec-action" id="recAction">Введите карты</div>
        <div class="rec-explain" id="recExplain"></div>
    </div>

    <!-- Подтверждение сплита -->
    <div class="split-confirm" id="splitConfirm">
        <button class="split-btn yes" onclick="confirmSplit()">Сделал сплит</button>
        <button class="split-btn no" onclick="declineSplit()">Нет</button>
    </div>

    <!-- Счётчик -->
    <div class="section">
        <div class="counter-row">
            <div class="counter-item">
                <div class="counter-value neutral" id="rcValue">+0</div>
                <div class="counter-label">RC</div>
            </div>
            <div class="counter-item">
                <div class="counter-value neutral" id="tcValue">+0.0</div>
                <div class="counter-label">TC</div>
            </div>
            <div class="counter-item">
                <div class="counter-value" id="decksRemain" style="color:#7f8c8d">4.0</div>
                <div class="counter-label">Колод</div>
            </div>
            <div class="counter-item">
                <div class="counter-value" id="betAdvice" style="color:#f39c12">1x</div>
                <div class="counter-label">Ставка</div>
            </div>
            <div class="counter-item">
                <div class="counter-value negative" id="advantage">-0.5%</div>
                <div class="counter-label">Перевес</div>
            </div>
        </div>
    </div>

    <!-- Режим ввода -->
    <div class="mode-buttons">
        <div class="mode-btn active-dealer" id="modeDealer" onclick="setMode('dealer')">Дилер</div>
        <div class="mode-btn" id="modePlayer" onclick="setMode('player')">Мои</div>
        <div class="mode-btn" id="modeOthers" onclick="setMode('others')">Чужие</div>
    </div>

    <!-- Кнопки карт -->
    <div class="card-grid" id="cardGrid">
        <div class="card-btn card-lo" onclick="selectRank('2')">2</div>
        <div class="card-btn card-lo" onclick="selectRank('3')">3</div>
        <div class="card-btn card-lo" onclick="selectRank('4')">4</div>
        <div class="card-btn card-lo" onclick="selectRank('5')">5</div>
        <div class="card-btn card-lo" onclick="selectRank('6')">6</div>
        <div class="card-btn card-mid" onclick="selectRank('7')">7</div>
        <div class="card-btn card-mid" onclick="selectRank('8')">8</div>
        <div class="card-btn card-mid" onclick="selectRank('9')">9</div>
        <div class="card-btn card-hi" onclick="selectRank('10')">10</div>
    </div>
    <div class="card-grid-row2" id="cardGridRow2">
        <div class="card-btn card-hi" onclick="selectRank('J')">J</div>
        <div class="card-btn card-hi" onclick="selectRank('Q')">Q</div>
        <div class="card-btn card-hi" onclick="selectRank('K')">K</div>
        <div class="card-btn card-hi" onclick="selectRank('A')">A</div>
    </div>

    <!-- Выбор масти -->
    <div class="suit-row" id="suitRow">
        <div class="suit-btn black" onclick="selectSuit('\u2660')" id="suitS"></div>
        <div class="suit-btn black" onclick="selectSuit('\u2663')" id="suitC"></div>
        <div class="suit-btn red" onclick="selectSuit('\u2665')" id="suitH"></div>
        <div class="suit-btn red" onclick="selectSuit('\u2666')" id="suitD"></div>
    </div>

    <!-- Управление -->
    <div class="ctrl-row">
        <button class="ctrl-btn" onclick="newHand()">Новая рука</button>
        <button class="ctrl-btn" onclick="undoCard()">Отмена</button>
        <button class="ctrl-btn" onclick="newShoe()">Новый шу</button>
    </div>

    <!-- Результат + настройки -->
    <div class="section">
        <div class="result-row" style="margin-bottom:8px">
            <button class="result-btn win" onclick="recordResult('win')">Выиграл</button>
            <button class="result-btn loss" onclick="recordResult('loss')">Проиграл</button>
            <button class="result-btn push" onclick="recordResult('push')">Ничья</button>
        </div>
        <div class="decks-row">
            <label>Колод в шу:</label>
            <select class="decks-select" id="decksSelect" onchange="changeDecks()">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="6">6</option>
                <option value="8">8</option>
            </select>
        </div>
        <div class="decks-row" style="margin-top:6px">
            <label>Масти:</label>
            <button class="ctrl-btn" id="suitToggle" onclick="toggleSuits()" style="flex:0;padding:4px 12px;font-size:12px">ВКЛ</button>
        </div>
        <div class="deck-estimate" id="deckEstimate"></div>
    </div>

    <div class="stats" id="statsLine">Сессия: 0 рук</div>
</div>

<script>
// =====================================================================
// СТРАТЕГИЯ
// =====================================================================

function getRank(card) {
    return card.replace(/[\u2660\u2663\u2665\u2666]/g, '');
}

function cardValue(rank) {
    rank = getRank(rank).toUpperCase().trim();
    if (['10','J','Q','K','T'].includes(rank)) return 10;
    if (['A','ACE'].includes(rank)) return 11;
    const n = parseInt(rank);
    return (n >= 2 && n <= 9) ? n : 0;
}

function handValue(cards) {
    let values = cards.map(c => cardValue(c));
    let total = values.reduce((a,b) => a+b, 0);
    let aces = values.filter(v => v === 11).length;
    while (total > 21 && aces > 0) { total -= 10; aces--; }
    return { total, isSoft: aces > 0 };
}

function isPair(cards) {
    return cards.length === 2 && cardValue(cards[0]) === cardValue(cards[1]);
}

const HARD = {
    5:{2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H',11:'H'},
    6:{2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H',11:'H'},
    7:{2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H',11:'H'},
    8:{2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H',11:'H'},
    9:{2:'H',3:'D',4:'D',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H',11:'H'},
    10:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'D',8:'D',9:'D',10:'H',11:'H'},
    11:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'D',8:'D',9:'D',10:'D',11:'H'},
    12:{2:'H',3:'H',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H',11:'H'},
    13:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H',11:'H'},
    14:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H',11:'H'},
    15:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H',11:'H'},
    16:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H',11:'H'},
    17:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    18:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    19:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    20:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    21:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
};

const SOFT = {
    13:{2:'H',3:'H',4:'H',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H',11:'H'},
    14:{2:'H',3:'H',4:'H',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H',11:'H'},
    15:{2:'H',3:'H',4:'D',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H',11:'H'},
    16:{2:'H',3:'H',4:'D',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H',11:'H'},
    17:{2:'H',3:'D',4:'D',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H',11:'H'},
    18:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'S',8:'S',9:'H',10:'H',11:'H'},
    19:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    20:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    21:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
};

const PAIRS = {
    2:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'H',9:'H',10:'H',11:'H'},
    3:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'H',9:'H',10:'H',11:'H'},
    4:{2:'H',3:'H',4:'H',5:'P',6:'P',7:'H',8:'H',9:'H',10:'H',11:'H'},
    5:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'D',8:'D',9:'D',10:'H',11:'H'},
    6:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'H',8:'H',9:'H',10:'H',11:'H'},
    7:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'H',9:'H',10:'H',11:'H'},
    8:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'P',9:'P',10:'P',11:'P'},
    9:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'S',8:'P',9:'P',10:'S',11:'S'},
    10:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S',11:'S'},
    11:{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'P',9:'P',10:'P',11:'P'},
};

// Коррекция стратегии для 1-2 колод (отличия от 4+ колод, S17 DAS)
const DECK_OVERRIDES = {
    1: { hard:{'8_5':'D','8_6':'D','9_2':'D','11_11':'D'}, soft:{'19_6':'D'}, pairs:{'6_7':'P'} },
    2: { hard:{'9_2':'D','11_11':'D'}, soft:{}, pairs:{} }
};

const ACTION_RU = { H:'ЕЩЁ', S:'ХВАТИТ', D:'ДАБЛ', P:'СПЛИТ' };

function getRecommendation(playerCards, dealerUpcard, skipSplit, tc) {
    const dv = cardValue(dealerUpcard);
    const {total, isSoft} = handValue(playerCards);
    const pair = isPair(playerCards);
    const canDouble = playerCards.length === 2;
    const canSplit = pair && !skipSplit;

    if (total === 21 && playerCards.length === 2)
        return { action:'S', ru:'БЛЭКДЖЕК!', explain:'Поздравляю!', total, isSoft };
    if (total > 21)
        return { action:'BUST', ru:'ПЕРЕБОР', explain:'Перебор — рука проиграна', total, isSoft:false };

    let action = 'S';

    if (pair && canSplit) {
        const pv = cardValue(playerCards[0]);
        // TC-девиация: сплит десяток при высоком счёте
        if (pv === 10 && tc !== undefined) {
            if (dv === 5 && tc >= 5) return { action:'P', ru:ACTION_RU.P, explain:'TC≥5: разделяй десятки против 5!', total, isSoft };
            if (dv === 6 && tc >= 4) return { action:'P', ru:ACTION_RU.P, explain:'TC≥4: разделяй десятки против 6!', total, isSoft };
        }
        // Коррекция пар для 1-2 колод
        const pOvr = DECK_OVERRIDES[totalDecks];
        if (pOvr && pOvr.pairs[pv+'_'+dv] === 'P') {
            return { action:'P', ru:ACTION_RU.P, explain:pairExplain(pv, dv), total, isSoft };
        }
        const pa = PAIRS[pv] && PAIRS[pv][dv];
        if (pa === 'P') {
            return { action:'P', ru:ACTION_RU.P, explain:pairExplain(pv, dv), total, isSoft };
        }
    }

    if (isSoft && SOFT[total]) {
        action = SOFT[total][dv] || 'H';
    } else if (HARD[total]) {
        action = HARD[total][dv] || 'H';
    } else {
        action = total >= 17 ? 'S' : 'H';
    }

    // Коррекция для 1-2 колод
    const ovr = DECK_OVERRIDES[totalDecks];
    if (ovr) {
        const key = total + '_' + dv;
        const oa = isSoft ? ovr.soft[key] : ovr.hard[key];
        if (oa) action = oa;
    }

    // Если дабл невозможен (3+ карт): soft 18+ → стоим, остальное → берём
    if (action === 'D' && !canDouble) action = (isSoft && total >= 18) ? 'S' : 'H';

    // Illustrious 18 — девиации на основе True Count
    let devExplain = null;
    if (!isSoft && tc !== undefined) {
        // Стоим при высоком счёте (колода богата десятками)
        if      (total === 16 && dv === 10 && tc >= 0 && action === 'H') { action = 'S'; devExplain = 'TC≥0: стоим с 16 против 10'; }
        else if (total === 15 && dv === 10 && tc >= 4 && action === 'H') { action = 'S'; devExplain = 'TC≥4: стоим с 15 против 10'; }
        else if (total === 12 && dv === 3  && tc >= 2 && action === 'H') { action = 'S'; devExplain = 'TC≥2: стоим с 12 против 3'; }
        else if (total === 12 && dv === 2  && tc >= 3 && action === 'H') { action = 'S'; devExplain = 'TC≥3: стоим с 12 против 2'; }
        else if (total === 16 && dv === 9  && tc >= 5 && action === 'H') { action = 'S'; devExplain = 'TC≥5: стоим с 16 против 9'; }
        // Удваиваем при высоком счёте
        else if (total === 10 && dv === 10 && tc >= 4 && canDouble) { action = 'D'; devExplain = 'TC≥4: удваиваем 10 против 10'; }
        else if (total === 10 && dv === 11 && tc >= 4 && canDouble) { action = 'D'; devExplain = 'TC≥4: удваиваем 10 против A'; }
        else if (total === 11 && dv === 11 && tc >= 1 && canDouble) { action = 'D'; devExplain = 'TC≥1: удваиваем 11 против A'; }
        else if (total === 9  && dv === 2  && tc >= 1 && canDouble) { action = 'D'; devExplain = 'TC≥1: удваиваем 9 против 2'; }
        else if (total === 9  && dv === 7  && tc >= 3 && canDouble) { action = 'D'; devExplain = 'TC≥3: удваиваем 9 против 7'; }
        // Берём при низком счёте (колода богата мелкими)
        else if (total === 13 && dv === 2 && tc < -1 && action === 'S') { action = 'H'; devExplain = 'TC<-1: берём с 13 против 2'; }
        else if (total === 12 && dv === 4 && tc < 0  && action === 'S') { action = 'H'; devExplain = 'TC<0: берём с 12 против 4'; }
        else if (total === 12 && dv === 5 && tc < -2 && action === 'S') { action = 'H'; devExplain = 'TC<-2: берём с 12 против 5'; }
        else if (total === 12 && dv === 6 && tc < -1 && action === 'S') { action = 'H'; devExplain = 'TC<-1: берём с 12 против 6'; }
        else if (total === 13 && dv === 3 && tc < -2 && action === 'S') { action = 'H'; devExplain = 'TC<-2: берём с 13 против 3'; }
    }

    if (devExplain) return { action, ru: ACTION_RU[action], explain: devExplain, total, isSoft };

    const ht = isSoft ? 'Soft' : 'Hard';
    const ds = dv === 11 ? 'A' : dv;
    let explain = '';
    if (action === 'S' && total >= 17) explain = `${ht} ${total} — сильная рука, стоим`;
    else if (action === 'S' && dv <= 6) explain = `${ht} ${total} vs ${ds} — дилер слабый, стоим`;
    else if (action === 'H' && dv >= 7) explain = `${ht} ${total} vs ${ds} — дилер сильный, берём`;
    else if (action === 'H') explain = `${ht} ${total} vs ${ds} — рука слабая, берём`;
    else if (action === 'D') explain = `${ht} ${total} vs ${ds} — выгодная позиция, удваиваем!`;
    else explain = `${ht} ${total} vs ${ds}`;

    return { action, ru: ACTION_RU[action], explain, total, isSoft };
}

function pairExplain(pv, dv) {
    if (pv === 11) return 'Тузы — ВСЕГДА разделяй';
    if (pv === 8) return 'Восьмёрки — ВСЕГДА разделяй';
    return `Разделяй пару против дилера ${dv === 11 ? 'A' : dv}`;
}

// =====================================================================
// Hi-Lo СЧЁТЧИК
// =====================================================================

const HI_LO = {};
[2,3,4,5,6].forEach(v => HI_LO[v] = 1);
[7,8,9].forEach(v => HI_LO[v] = 0);
[10,11].forEach(v => HI_LO[v] = -1);

let totalDecks = 4;
let runningCount = 0;
let cardsDealt = 0;

function addToCounter(rank) {
    const v = cardValue(rank);
    runningCount += (HI_LO[v] || 0);
    cardsDealt++;
}

function removeFromCounter(rank) {
    const v = cardValue(rank);
    runningCount -= (HI_LO[v] || 0);
    cardsDealt = Math.max(0, cardsDealt - 1);
}

function trueCount() {
    const dr = Math.max((totalDecks * 52 - cardsDealt) / 52, 0.25);
    return runningCount / dr;
}

function decksRemaining() {
    return Math.max((totalDecks * 52 - cardsDealt) / 52, 0);
}

function betAdvice() {
    const tc = trueCount();
    if (tc <= 0) return { text: '1x', mult: 1 };
    if (tc < 2) return { text: '2x', mult: 2 };
    if (tc < 4) return { text: '3x', mult: 3 };
    if (tc < 6) return { text: '5x', mult: 5 };
    return { text: '8x!', mult: 8 };
}

function playerAdvantage() {
    return -0.5 + trueCount() * 0.5;
}

// =====================================================================
// СОСТОЯНИЕ
// =====================================================================

let dealerCards = [];
let playerCards = [];
let othersCards = [];
let allHandCards = [];
let inputMode = 'dealer';
let stats = { hands: 0, wins: 0, losses: 0, pushes: 0 };
let pendingRank = null;
let cardTracker = {};

// Сплит
let splitMode = false;
let splitHands = [[], []];
let currentSplitHand = 0;
let splitDeclined = false;
let suitsEnabled = true;

// =====================================================================
// ФУНКЦИИ UI
// =====================================================================

function selectRank(rank) {
    if (suitsEnabled) {
        pendingRank = rank;
        updateUI();
    } else {
        addCard(rank);
    }
}

function toggleSuits() {
    suitsEnabled = !suitsEnabled;
    pendingRank = null;
    document.getElementById('suitToggle').textContent = suitsEnabled ? 'ВКЛ' : 'ВЫКЛ';
    updateUI();
}

function selectSuit(suit) {
    if (!pendingRank) return;
    const card = pendingRank + suit;
    pendingRank = null;
    addCard(card);
}

function addCard(card) {
    const rank = getRank(card);
    let target = inputMode;
    if (inputMode === 'dealer') {
        dealerCards.push(card);
        if (dealerCards.length === 1) {
            inputMode = 'player';
        }
    } else if (inputMode === 'others') {
        othersCards.push(card);
    } else if (splitMode) {
        target = 'split' + currentSplitHand;
        splitHands[currentSplitHand].push(card);
    } else {
        target = 'player';
        playerCards.push(card);
    }
    allHandCards.push({ card, target });
    addToCounter(rank);
    cardTracker[card] = (cardTracker[card] || 0) + 1;
    updateUI();
    if (window.Telegram && Telegram.WebApp) {
        try { Telegram.WebApp.HapticFeedback.impactOccurred('light'); } catch(e) {}
    }
}

function undoCard() {
    if (pendingRank) {
        pendingRank = null;
        updateUI();
        return;
    }
    if (allHandCards.length === 0) return;
    const lastEntry = allHandCards.pop();
    const rank = getRank(lastEntry.card);
    removeFromCounter(rank);

    if (cardTracker[lastEntry.card]) {
        cardTracker[lastEntry.card]--;
        if (cardTracker[lastEntry.card] <= 0) delete cardTracker[lastEntry.card];
    }

    if (lastEntry.target === 'dealer') {
        dealerCards.pop();
        if (dealerCards.length === 0) {
            inputMode = 'dealer';
        }
    } else if (lastEntry.target === 'others') {
        othersCards.pop();
    } else if (lastEntry.target === 'split0') {
        splitHands[0].pop();
    } else if (lastEntry.target === 'split1') {
        splitHands[1].pop();
    } else {
        playerCards.pop();
    }
    updateUI();
}

function confirmSplit() {
    if (playerCards.length !== 2) return;
    splitMode = true;
    splitHands = [[playerCards[0]], [playerCards[1]]];
    currentSplitHand = 0;

    // Обновить targets в allHandCards: последние 2 записи 'player' → 'split1' и 'split0'
    let found = 0;
    for (let i = allHandCards.length - 1; i >= 0 && found < 2; i--) {
        if (allHandCards[i].target === 'player') {
            allHandCards[i].target = found === 0 ? 'split1' : 'split0';
            found++;
        }
    }

    playerCards = [];
    splitDeclined = false;
    inputMode = 'player';
    updateUI();
}

function declineSplit() {
    splitDeclined = true;
    updateUI();
}

function switchSplitHand(idx) {
    if (!splitMode) return;
    currentSplitHand = idx;
    inputMode = 'player';
    updateUI();
}

function newHand() {
    dealerCards = [];
    playerCards = [];
    othersCards = [];
    allHandCards = [];
    pendingRank = null;
    splitMode = false;
    splitHands = [[], []];
    currentSplitHand = 0;
    splitDeclined = false;
    inputMode = 'dealer';
    updateUI();
}

function newShoe() {
    runningCount = 0;
    cardsDealt = 0;
    cardTracker = {};
    newHand();
}

function setMode(mode) {
    pendingRank = null;
    inputMode = mode;
    updateUI();
}

function changeDecks() {
    totalDecks = parseInt(document.getElementById('decksSelect').value);
    runningCount = 0;
    cardsDealt = 0;
    cardTracker = {};
    newHand();
}

function recordResult(result) {
    stats.hands++;
    if (result === 'win') stats.wins++;
    else if (result === 'loss') stats.losses++;
    else stats.pushes++;
    newHand();
}

function renderCards(container, cards) {
    if (cards.length === 0) {
        container.innerHTML = '<span style="color:#555">—</span>';
        return;
    }
    container.innerHTML = cards.map(c => {
        const rank = getRank(c);
        const suit = c.replace(rank, '');
        const isRed = suit === '\u2665' || suit === '\u2666';
        return `<div class="card-chip">${rank}<span style="color:${isRed ? '#e74c3c' : '#aaa'}">${suit}</span></div>`;
    }).join('');
}

function renderHandTotal(el, cards) {
    if (cards.length === 0) { el.textContent = ''; return; }
    const {total, isSoft} = handValue(cards);
    const type = isSoft ? 'soft' : 'hard';
    if (total === 21 && cards.length === 2) el.textContent = 'БД!';
    else if (total > 21) el.textContent = `${total} ПЕРЕБОР`;
    else el.textContent = `${total} (${type})`;
}

function updateUI() {
    // Дилер
    renderCards(document.getElementById('dealerCards'), dealerCards);
    const dt = document.getElementById('dealerTotal');
    if (dealerCards.length > 1) {
        const {total: dTotal} = handValue(dealerCards);
        dt.textContent = `(${dTotal})`;
    } else if (dealerCards.length === 1) {
        dt.textContent = `(${cardValue(dealerCards[0])})`;
    } else dt.textContent = '';

    // Мои карты / Сплит
    const playerRow = document.getElementById('playerRow');
    const splitRow1 = document.getElementById('splitRow1');
    const splitRow2 = document.getElementById('splitRow2');

    if (splitMode) {
        playerRow.style.display = 'none';
        splitRow1.style.display = 'flex';
        splitRow2.style.display = 'flex';

        renderCards(document.getElementById('splitCards1'), splitHands[0]);
        renderCards(document.getElementById('splitCards2'), splitHands[1]);
        renderHandTotal(document.getElementById('splitTotal1'), splitHands[0]);
        renderHandTotal(document.getElementById('splitTotal2'), splitHands[1]);

        const label1 = document.getElementById('splitLabel1');
        const label2 = document.getElementById('splitLabel2');
        splitRow1.className = 'hand-row split-hand' + (currentSplitHand === 0 ? ' active' : '');
        splitRow2.className = 'hand-row split-hand' + (currentSplitHand === 1 ? ' active' : '');

        if (currentSplitHand === 0) {
            label1.textContent = 'Рука 1 \u25b8';
            label1.className = 'hand-label split-active';
            label2.textContent = 'Рука 2:';
            label2.className = 'hand-label split-inactive';
        } else {
            label1.textContent = 'Рука 1:';
            label1.className = 'hand-label split-inactive';
            label2.textContent = 'Рука 2 \u25b8';
            label2.className = 'hand-label split-active';
        }

        // Добавить ПАРА если опять пара в сплит-руке
        for (let i = 0; i < 2; i++) {
            const totalEl = document.getElementById('splitTotal' + (i + 1));
            if (splitHands[i].length === 2 && isPair(splitHands[i])) {
                totalEl.textContent += ' | ПАРА';
            }
        }
    } else {
        playerRow.style.display = 'flex';
        splitRow1.style.display = 'none';
        splitRow2.style.display = 'none';

        renderCards(document.getElementById('playerCards'), playerCards);
        const pt = document.getElementById('playerTotal');
        if (playerCards.length > 0) {
            const {total, isSoft} = handValue(playerCards);
            const type = isSoft ? 'soft' : 'hard';
            const pair = isPair(playerCards) ? ' | ПАРА' : '';
            if (total === 21 && playerCards.length === 2) pt.textContent = 'БД!';
            else if (total > 21) pt.textContent = `${total} ПЕРЕБОР`;
            else pt.textContent = `${total} (${type})${pair}`;
        } else pt.textContent = '';
    }

    // Чужие
    const othersRow = document.getElementById('othersRow');
    renderCards(document.getElementById('othersCards'), othersCards);
    if (othersCards.length > 0) {
        othersRow.style.display = 'flex';
        document.getElementById('othersCount').textContent = `(${othersCards.length} шт)`;
    } else othersRow.style.display = 'none';

    // Рекомендация
    const box = document.getElementById('recBox');
    const actEl = document.getElementById('recAction');
    const expEl = document.getElementById('recExplain');
    const splitConfirmEl = document.getElementById('splitConfirm');

    // Определяем текущую руку для рекомендации
    const currentCards = splitMode ? splitHands[currentSplitHand] : playerCards;
    const hasEnoughCards = currentCards.length >= 2;

    if (dealerCards.length >= 1 && hasEnoughCards) {
        const rec = getRecommendation(currentCards, dealerCards[0], splitDeclined, trueCount());
        const prefix = splitMode ? `Рука ${currentSplitHand + 1}: ` : '';
        actEl.textContent = `>> ${rec.ru} <<`;
        expEl.textContent = prefix + rec.explain;
        box.className = 'recommendation rec-' +
            ({H:'hit',S:'stand',D:'double',P:'split',BUST:'bust'}[rec.action] || 'waiting');

        // Страховка при TC >= 3 и дилер с тузом
        if (cardValue(dealerCards[0]) === 11 && trueCount() >= 3) {
            expEl.textContent = 'СТРАХОВКА! (TC\u22653) | ' + expEl.textContent;
        }

        // Показать кнопки подтверждения сплита
        if (rec.action === 'P' && !splitMode && !splitDeclined) {
            splitConfirmEl.className = 'split-confirm visible';
        } else {
            splitConfirmEl.className = 'split-confirm';
        }
    } else {
        splitConfirmEl.className = 'split-confirm';
        if (dealerCards.length === 0) {
            actEl.textContent = 'Нажмите карту дилера';
        } else if (currentCards.length === 0) {
            actEl.textContent = splitMode ? `Рука ${currentSplitHand + 1}: добавьте карту` : 'Нажмите 2 свои карты';
        } else if (currentCards.length === 1) {
            actEl.textContent = splitMode ? `Рука ${currentSplitHand + 1}: ещё 1 карту` : 'Нажмите ещё 1 свою карту';
        } else {
            actEl.textContent = 'Введите карты';
        }
        expEl.textContent = '';
        box.className = 'recommendation rec-waiting';
    }

    // Режимы
    ['Dealer','Player','Others'].forEach(m => {
        const el = document.getElementById('mode' + m);
        const ml = m.toLowerCase();
        el.className = 'mode-btn' + (inputMode === ml ? ` active-${ml}` : '');
    });

    // Выбор масти
    const suitRow = document.getElementById('suitRow');
    const cardGrid = document.getElementById('cardGrid');
    const cardGridRow2 = document.getElementById('cardGridRow2');
    if (pendingRank) {
        suitRow.className = 'suit-row visible';
        document.getElementById('suitS').textContent = pendingRank + '\u2660';
        document.getElementById('suitC').textContent = pendingRank + '\u2663';
        document.getElementById('suitH').textContent = pendingRank + '\u2665';
        document.getElementById('suitD').textContent = pendingRank + '\u2666';
        cardGrid.classList.add('dimmed');
        cardGridRow2.classList.add('dimmed');
    } else {
        suitRow.className = 'suit-row';
        cardGrid.classList.remove('dimmed');
        cardGridRow2.classList.remove('dimmed');
    }

    // Счётчик
    const rc = runningCount;
    const tc = trueCount();
    const dr = decksRemaining();
    const ba = betAdvice();
    const adv = playerAdvantage();

    const rcEl = document.getElementById('rcValue');
    rcEl.textContent = (rc >= 0 ? '+' : '') + rc;
    rcEl.className = 'counter-value ' + (rc > 0 ? 'positive' : rc < 0 ? 'negative' : 'neutral');

    const tcEl = document.getElementById('tcValue');
    tcEl.textContent = (tc >= 0 ? '+' : '') + tc.toFixed(1);
    tcEl.className = 'counter-value ' + (tc > 0 ? 'positive' : tc < 0 ? 'negative' : 'neutral');

    document.getElementById('decksRemain').textContent = dr.toFixed(1);
    document.getElementById('betAdvice').textContent = ba.text;

    const advEl = document.getElementById('advantage');
    advEl.textContent = (adv >= 0 ? '+' : '') + adv.toFixed(1) + '%';
    advEl.className = 'counter-value ' + (adv >= 0 ? 'positive' : 'negative');

    // Оценка колод
    const estimateEl = document.getElementById('deckEstimate');
    let maxCount = 0, maxCard = '';
    for (const card in cardTracker) {
        if (cardTracker[card] > maxCount) {
            maxCount = cardTracker[card];
            maxCard = card;
        }
    }
    if (maxCount >= 2) {
        estimateEl.textContent = `Мин. колод: ${maxCount} (${maxCard} выпала ${maxCount}\u00d7)`;
        estimateEl.style.display = 'block';
    } else {
        estimateEl.style.display = 'none';
    }

    // Статистика
    const s = stats;
    if (s.hands > 0) {
        const wr = (s.wins / s.hands * 100).toFixed(0);
        document.getElementById('statsLine').textContent =
            `Сессия: ${s.hands} рук | W:${s.wins} L:${s.losses} P:${s.pushes} | ${wr}%`;
    } else {
        document.getElementById('statsLine').textContent = 'Сессия: 0 рук';
    }
}

// =====================================================================
// ИНИЦИАЛИЗАЦИЯ
// =====================================================================

if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
}

updateUI();
</script>
</body>
</html>
